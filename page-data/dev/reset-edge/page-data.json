{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/dev/reset-edge","result":{"data":{"site":{"siteMetadata":{"title":"nandemonas","author":"Nas Villanueva"}},"post":{"id":"d5ca13d3-5441-51dc-8083-a71b6dff3e12","html":"<p>Like almost everybody else, we <em>need to</em> test our app in Microsoft Edge, and since we are using <a href=\"https://angularjs.org/\" target=\"_blank\">Angular.js</a>\nit seems that <a href=\"https://karma-runner.github.io/\" target=\"_blank\">Karma</a> + <a href=\"https://www.npmjs.com/package/karma-edge-launcher\" target=\"_blank\">karma-edge-launcher</a> are the best tools to\ndo that. The problem is, karma-edge-launcher‚Äôs latest version, 0.8.2 at the time of writing, doesn‚Äôt <em>gracefully</em> shuts down Edge which makes it restore\nall tabs upon next launch. That‚Äôs why consecutive CI builds floods Edge with tabs until it stops launching and the only way to fix it is to restart the build server.</p>\n<!--excerpt-->\n<p>Before heading to the solution, I‚Äôd like to list down some Github Tickets related to this issue:</p>\n<ul>\n<li><a href=\"https://github.com/MicrosoftEdge/edge-launcher/issues/23\">edge-launcher#23</a>: Edge opens with wrong address</li>\n<li><a href=\"https://github.com/karma-runner/karma-edge-launcher/issues/1\">karma-edge-launcher#1</a>: Error launching Edge on Windows 10 in CI environment (karma, jenkins)</li>\n<li><a href=\"https://github.com/karma-runner/karma-edge-launcher/issues/4\">karma-edge-launcher#4</a>: Edge does not close its tabs</li>\n<li><a href=\"https://github.com/nickmccurdy/karma-edge-launcher/pull/33\">karma-edge-launcher#33</a>: remove /f flag from kill command and call it twice so edge exits cleanly</li>\n<li>and more‚Ä¶</li>\n</ul>\n<p>There‚Äôs a lot of tickets being related to each other that‚Äôs related to this issue, and even though some of them are already close, no one seems to be able to fix it\nor they just gave up.</p>\n<h2>Initial Solution</h2>\n<p><em><strong>Spoiler Alert</strong>: It didn‚Äôt fix the issue.</em></p>\n<p>I asked a coworker who is knowledgeable about Windows and he gave me this powershell script that sends <code class=\"language-text\">Alt+F4</code> to Edge:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-powershell line-numbers\"><code class=\"language-powershell\"><span class=\"token variable\">$wshell</span> = <span class=\"token function\">New-Object</span> <span class=\"token operator\">-</span>ComObject wscript<span class=\"token punctuation\">.</span>shell<span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$wshell</span><span class=\"token punctuation\">.</span>AppActivate<span class=\"token punctuation\">(</span><span class=\"token string\">'Microsoft Edge'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">out-null</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">Sleep</span> 1<span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$wshell</span><span class=\"token punctuation\">.</span>SendKeys<span class=\"token punctuation\">(</span><span class=\"token string\">\"%{f4}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This script works <strong>IF</strong> Edge still runs when it is executed. Unfortunately, the problem was Edge can‚Äôt launch anymore and karma-edge-launcher makes sure that\nit is <em>ungracefully</em> killed.</p>\n<h2>Actual Solution</h2>\n<p>While trying too look for a solution, I saw articles about Edge being broken and how to fix it by resetting it to a fresh state.\nSo I thought <em>‚ÄúWhat if we can use the same method before each test to clear all restored tabs‚Äù</em>, then I‚Äôve come up with this powershell script\nbased on what I‚Äôve read.</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-powershell line-numbers\"><code class=\"language-powershell\"><span class=\"token variable\">$MicrosoftEdgePath</span> = <span class=\"token function\">Join-Path</span> <span class=\"token variable\">$ENV</span>:APPDATA <span class=\"token string\">\"..\\Local\\Packages\\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\"</span> <span class=\"token operator\">-</span>Resolve <span class=\"token operator\">-</span>ErrorAction SilentlyContinue\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$MicrosoftEdgePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># Take Ownership of Edge's data folder</span>\n    takeown <span class=\"token operator\">/</span>F <span class=\"token variable\">$MicrosoftEdgePath</span>\\<span class=\"token operator\">*</span> <span class=\"token operator\">/</span>R <span class=\"token operator\">/</span>A\n    icacls <span class=\"token variable\">$MicrosoftEdgePath</span>\\<span class=\"token operator\">*</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token operator\">/</span>T <span class=\"token operator\">/</span>grant administrators:F\n    <span class=\"token comment\"># Delete Edge's data folder starting from the inner most file</span>\n    <span class=\"token function\">Get-ChildItem</span> <span class=\"token operator\">-</span>Path <span class=\"token variable\">$MicrosoftEdgePath</span> <span class=\"token operator\">-</span>Force <span class=\"token operator\">-</span>Recurse <span class=\"token punctuation\">|</span>\n            <span class=\"token function\">Sort-Object</span> <span class=\"token operator\">-</span>Property FullName <span class=\"token operator\">-</span>Descending <span class=\"token punctuation\">|</span>\n            <span class=\"token function\">Remove-Item</span> <span class=\"token operator\">-</span>Recurse <span class=\"token operator\">-</span>Force\n    <span class=\"token function\">rm</span> <span class=\"token variable\">$MicrosoftEdgePath</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\"># Re-setup Edge</span>\n<span class=\"token function\">Get-AppXPackage</span> <span class=\"token operator\">-</span>AllUsers <span class=\"token operator\">-</span>Name Microsoft<span class=\"token punctuation\">.</span>MicrosoftEdge <span class=\"token punctuation\">|</span>\n        <span class=\"token keyword\">Foreach</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Add-AppxPackage</span> <span class=\"token operator\">-</span>DisableDevelopmentMode <span class=\"token operator\">-</span>Register <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>InstallLocation <span class=\"token punctuation\">)</span></span>\\AppXManifest.xml\"</span> <span class=\"token operator\">-</span>Verbose\n        <span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Now, we don‚Äôt need to restart the server manually every time Karma breaks Edge. üòé</p>\n<br>\n<p>References:</p>\n<ul>\n<li><a href=\"https://stackoverflow.com/a/34636812\">https://stackoverflow.com/a/34636812</a></li>\n<li><a href=\"https://www.groovypost.com/howto/reset-microsoft-edge-default-settings/\">https://www.groovypost.com/howto/reset-microsoft-edge-default-settings/</a></li>\n<li><a href=\"https://www.apeswithcomputers.com/article/take-ownership-with-the-command-prompt-powershell\">https://www.apeswithcomputers.com/article/take-ownership-with-the-command-prompt-powershell</a></li>\n</ul>","frontmatter":{"title":"reset_edge.ps1 ‚Äî Prevent Karma tests from breaking Microsoft Edge","date":"2019-03-15","tags":["Scripts","Powershell","DevOps"]}},"relatedPosts":{"nodes":[{"frontmatter":{"tags":["Scripts","Docker","Shell","DevOps"],"date":"2017-08-11","title":"Migrating Docker Images"},"fields":{"readingTime":{"text":"3 min read"},"site":"dev","slug":"/dev/migrating-docker-images"}},{"frontmatter":{"tags":["Scripts","Bash","Shell"],"date":"2017-06-12","title":"Monitor Hotplug for Linux"},"fields":{"readingTime":{"text":"2 min read"},"site":"dev","slug":"/dev/monitor-hotplug"}},{"frontmatter":{"tags":["Scripts","Powershell","DevOps"],"date":"2019-03-15","title":"reset_edge.ps1 ‚Äî Prevent Karma tests from breaking Microsoft Edge"},"fields":{"readingTime":{"text":"3 min read"},"site":"dev","slug":"/dev/reset-edge"}}]}},"pageContext":{"slug":"/dev/reset-edge","tags":["Scripts","Powershell","DevOps"]}},"staticQueryHashes":[]}